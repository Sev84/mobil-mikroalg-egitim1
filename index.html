<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIQ-Alg 0CO2: Hava Kalitesi Paneli</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Leaflet CSS - Harita için gerekli -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #073B4C; }
        .font-heading { font-family: 'Montserrat', sans-serif; }
        .chart-container { position: relative; width: 100%; max-width: 550px; margin: auto; height: 320px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        .kpi-card { background: #ffffff; border-radius: 0.75rem; padding: 1rem; text-align: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .nav-link { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            line-height: 1rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        .nav-link.active { color: #118AB2; font-weight: 700; }
        [title]:hover { cursor: help; }
        .analysis-card {
            background: linear-gradient(135deg, #073B4C 0%, #118AB2 100%);
            color: white;
        }
        .analysis-content {
            text-align: left;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .chat-message { margin-bottom: 1rem; display: flex; }
        .chat-message.user { justify-content: flex-end; }
        .chat-message.ai { justify-content: flex-start; }
        .chat-message p { padding: 0.75rem 1.25rem; border-radius: 1.25rem; max-width: 85%; text-align: left; line-height: 1.5; }
        .chat-message.user p { background-color: #118AB2; color: white; border-bottom-right-radius: 0.25rem; }
        .chat-message.ai p { background-color: #E9ECEF; color: #073B4C; border-bottom-left-radius: 0.25rem; }
        #chat-submit:disabled { background-color: #9ca3af; cursor: not-allowed; }
        
        #mapid {
            height: 500px;
            width: 100%;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .aqi-marker {
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
            font-size: 14px;
            width: 40px;
            height: 40px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .message-box.show { opacity: 1; }
        .message-box.success { background-color: #06D6A0; }
        .message-box.error { background-color: #EF476F; }

        /* Ayarlar ikonu animasyonu */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 214, 160, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(6, 214, 160, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(6, 214, 160, 0); }
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body class="antialiased">

    <header class="bg-white/95 backdrop-blur-sm sticky top-0 z-50 shadow-md">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#hero" class="flex items-center">
                <img src="logo111.png" alt="BIQ-Alg 0CO2 Proje Logosu" class="h-12 w-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x50/FFFFFF/073B4C?text=BiQ-Alg+0CO2';">
            </a>
            <div class="hidden md:flex items-center space-x-4">
                <a href="#problem-solution" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
                    <span>Çözüm</span>
                </a>
                <a href="#technology" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                    <span>Teknoloji</span>
                </a>
                <a href="#live-data" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                    <span>Canlı Veri</span>
                </a>
                <a href="#city-comparison" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8a6 6 0 0 0-8.4-8.4"></path><path d="M13 10.7a6 6 0 0 0 8.4 8.4"></path></svg>
                    <span>Karşılaştırma</span>
                </a>
                <a href="#ai-chat-section" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                    <span>Yapay Zeka</span>
                </a>
                <a href="#podcast-section" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                    <span>Podcast</span>
                </a>
                <a href="#project-resources" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                    <span>Kaynaklar</span>
                </a>
                <a href="#stats-section" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>İstatistikler</span>
                </a>
                <a id="settings-nav-link" href="#api-key-section" class="nav-link text-gray-600 hover:text-[#118AB2] font-semibold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 7.8C14.2 6.5 12.2 6.5 11 7.8s-1.2 3.2 0 4.5l4.2 4.2c1.2 1.2 3.2 1.2 4.5 0s1.2-3.2 0-4.5L15.5 7.8z"></path><path d="m12.2 11 4.5 4.5"></path><path d="M7.8 15.5c-1.2-1.2-1.2-3.2 0-4.5l4.2-4.2c1.2-1.2 3.2-1.2 4.5 0"></path></svg>
                    <span>Ayarlar</span>
                </a>
            </div>
        </nav>
    </header>

    <main>
        <section id="hero" class="py-20 md:py-32" style="background: linear-gradient(135deg, #118AB2 0%, #06D6A0 100%);">
            <div class="container mx-auto px-6 text-center text-white">
                <h1 class="text-4xl md:text-6xl font-bold font-heading mb-4 tracking-tight">Afet Sonrası Temiz Nefes: <br> BIQ-Alg 0CO2</h1>
                <p class="text-lg md:text-xl max-w-3xl mx-auto opacity-90">
                    Doğanın en güçlü savaşçıları olan mikroalgler ile afet bölgelerine anında hava kalitesi, sürdürülebilir enerji ve umut taşıyan mobil eğitim istasyonunu keşfedin.
                </p>
            </div>
        </section>

        <section id="problem-solution" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Görünmez Tehlikeye Karşı Biyolojik Kalkan</h2>
                </div>
                <div class="grid md:grid-cols-3 gap-8 items-center text-center">
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="font-heading text-2xl font-bold text-[#FF6B6B] mb-3">GELENEKSEL YÖNTEMLER</h3>
                        <p class="text-gray-600">Enerji yoğun, maliyetli ve sadece partikül filtreler. CO₂ yakalama veya O₂ üretme yetenekleri yoktur.</p>
                    </div>
                    <div class="p-8">
                            <div class="text-6xl md:text-8xl font-black text-[#118AB2] font-heading">50x</div>
                            <p class="font-bold text-xl mt-2 text-[#073B4C]">DAHA VERİMLİ</p>
                            <p class="text-gray-600 mt-1">Mikroalgler, karasal bitkilere göre 10 ila 50 kat daha verimli CO₂ yakalar.</p>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="font-heading text-2xl font-bold text-[#06D6A0] mb-3">MİKROALG ÇÖZÜMÜ</h3>
                        <p class="text-gray-600">Havayı temizler, oksijen üretir ve döngüsel ekonomi için değerli biyokütle oluşturur.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="technology" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Hava Arıtmanın Kalbi: Fotobiyoreaktör (FBR) Teknolojileri</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Mikroalglerin gücünü en verimli şekilde kullanmak için farklı reaktör tasarımları mevcuttur. Her birinin kendine özgü avantajları ve performans metrikleri bulunur. Projemiz, mobilite ve verimliliği birleştiren Dikey Tübüler FBR tasarımını temel alır.
                    </p>
                </div>
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div class="chart-container">
                        <canvas id="pbrPerformanceChart"></canvas>
                    </div>
                    <div id="pbr-info" class="space-y-4">
                        <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300">
                                <h3 class="text-xl font-bold font-heading mb-2 text-[#118AB2]">Dikey Tübüler FBR (Projemizin Seçimi)</h3>
                            <p class="text-gray-600">Kompakt yapısıyla mobil uygulamalar için idealdir. Kontrollü ortamı sayesinde yüksek verimlilik ve stabilite sunar. Az yer kaplar ve afet bölgelerinde hızla kurulabilir.</p>
                        </div>
                            <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 opacity-70">
                                <h3 class="text-xl font-bold font-heading mb-2 text-[#073B4C]">Düz Panel FBR</h3>
                            <p class="text-gray-600">Yüksek ışık verimliliği sağlar ancak genellikle daha büyük ve sabit kurulumlar için uygundur.</p>
                        </div>
                            <div class="bg-white p-6 rounded-lg shadow-md transition-all duration-300 opacity-70">
                                <h3 class="text-xl font-bold font-heading mb-2 text-[#073B4C]">Açık Havuz Sistemleri</h3>
                            <p class="text-gray-600">Düşük maliyetlidir ancak kirlenme riski yüksek ve verimliliği düşüktür.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="live-data" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Cihazdan Gelen Canlı Veriler</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        BIQ-Alg 0CO2 istasyonundan gelen gerçek zamanlı sensör verilerini buradan takip edin.
                    </p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8 text-center">
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">CO₂ SEVİYESİ</h4><p id="kpi-co2" class="text-3xl font-black text-[#118AB2] mt-1">--- <span class="text-lg">ppm</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">HAVA KALİTESİ</h4><p id="kpi-air-quality" class="text-3xl font-black text-[#06D6A0] mt-1">---</p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">IŞIK ŞİDDETİ</h4><p id="kpi-light" class="text-3xl font-black text-[#FFD166] mt-1">--- <span class="text-lg">lux</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">SICAKLIK</h4><p id="kpi-temp" class="text-3xl font-black text-[#FF6B6B] mt-1">-- <span class="text-lg">°C</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">NEM</h4><p id="kpi-humidity" class="text-3xl font-black text-[#118AB2] mt-1">-- <span class="text-lg">%</span></p></div>
                    <div class="kpi-card p-4"><h4 class="font-bold text-gray-500 text-sm">SU KALİTESİ (TDS)</h4><p id="kpi-tds" class="text-3xl font-black text-[#EF476F] mt-1">--- <span class="text-lg">ppm</span></p></div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">CO₂ Seviyesi Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="co2Chart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Su Kalitesi Trendi (TDS)</h3><div class="chart-container" style="height: 300px;"><canvas id="tdsChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Işık Şiddeti Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="lightChart"></canvas></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-lg"><h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Sıcaklık ve Nem Trendi</h3><div class="chart-container" style="height: 300px;"><canvas id="tempHumidityChart"></canvas></div></div>
                </div>
                
                <div class="text-center mb-12">
                    <button id="download-csv-button" class="bg-[#073B4C] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#118AB2] transition-colors shadow-md">
                        Grafik Verilerini Kaydet (CSV)
                    </button>
                </div>

                <div id="analysis-container" class="p-6 rounded-xl shadow-lg analysis-card">
                    <h3 class="text-2xl font-bold font-heading text-center mb-4 text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 -mt-1"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.94.24q-.15-.48-.4-1.24a5.5 5.5 0 0 0-5.4-4.51H1.5A2.5 2.5 0 0 1-1 11.5v-3A2.5 2.5 0 0 1 1.5 6H2a5.5 5.5 0 0 0 4.88-3.32q.25-.76.4-1.24A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2a2.5 2.5 0 0 0-2.5 2.5v15a2.5 2.5 0 0 0 4.94.24q-.15-.48.4-1.24a5.5 5.5 0 0 1 5.4-4.51H22.5A2.5 2.5 0 0 0 25 11.5v-3A2.5 2.5 0 0 0 22.5 6H22a5.5 5.5 0 0 1-4.88-3.32q-.25-.76-.4-1.24A2.5 2.5 0 0 0 14.5 2Z"></path></svg>
                        Yapay Zeka Verimlilik Analizi
                    </h3>
                    <div id="efficiency-analysis" class="text-lg text-gray-200 analysis-content">
                        <p class="text-center">Yeterli veri toplanıyor...</p>
                    </div>
                </div>

            </div>
        </section>
        
        <section id="city-comparison" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Deprem Bölgeleri Hava Kalitesi Karşılaştırması</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        BIQ-Alg istasyonunun (İstanbul) anlık hava temizleme performansını, diğer deprem bölgesi şehirlerinin genel durumuyla karşılaştırın.
                    </p>
                </div>
                <div class="overflow-x-auto bg-white rounded-xl shadow-lg mb-8">
                    <table class="w-full text-left">
                        <thead class="bg-[#073B4C] text-white">
                            <tr>
                                <th class="p-4 font-bold uppercase tracking-wider">Şehir</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Hava Kalite İndeksi (HKİ)</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Kirletici Değeri</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Durum</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Ana Kirletici</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Ölçüm Tarihi</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-table-body" class="divide-y divide-gray-200">
                                <tr><td colspan="6" class="p-8 text-center text-gray-500">Veriler yükleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 text-blue-800 rounded-r-lg">
                    <h4 class="font-bold">Veri Kaynağı Hakkında</h4>
                    <p class="text-sm mt-1">Karşılaştırma verileri, dünya genelinde 30,000'den fazla istasyondan veri toplayan kâr amacı gütmeyen bir kuruluş olan <strong>World Air Quality Index Project</strong> tarafından sağlanmaktadır. Bu platform, vatandaşların yaşadıkları yerdeki hava kirliliği hakkında bilinçlenmesine yardımcı olmayı hedefler.</p>
                </div>
            </div>
        </section>

        <section id="map-section" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Hava Kalitesi Haritası</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Deprem bölgeleri ve BIQ-Alg istasyonunun hava kalitesi verilerini harita üzerinde görselleştirin.
                    </p>
                </div>
                <div id="mapid" class="w-full h-[500px] rounded-xl shadow-lg border border-gray-200"></div>
            </div>
        </section>

        <section id="ai-chat-section" class="py-16 md:py-24 bg-gray-100">
                 <div class="container mx-auto px-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                        <h3 class="text-2xl font-bold font-heading text-center mb-4 text-[#073B4C]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 -mt-1"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path><path d="m15 5 4 4"></path></svg>
                            Yapay Zeka Asistanı ile Sohbet Edin
                        </h3>
                        <div id="chat-container" class="h-80 overflow-y-auto p-4 border rounded-lg mb-4 bg-gray-50">
                            <div class="chat-message ai">
                                <p>Merhaba! Ben BIQ-Alg asistanıyım. Yapay zeka özelliklerini kullanmak için lütfen Ayarlar sekmesinden API anahtarınızı girin.</p>
                            </div>
                        </div>
                        <form id="chat-form" class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="Sorunuzu buraya yazın..." class="flex-grow p-3 border rounded-lg focus:ring-2 focus:ring-[#118AB2] focus:outline-none">
                            <button type="submit" id="chat-submit" class="bg-[#073B4C] text-white font-bold py-2 px-5 rounded-lg hover:bg-[#118AB2] transition-colors flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                            </button>
                        </form>
                    </div>
                </div>
        </section>

        <section id="summary-table-section" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Projenin Öne Çıkan Yönleri</h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left rounded-lg shadow-lg overflow-hidden">
                        <thead class="bg-[#118AB2] text-white">
                            <tr>
                                <th class="p-4 font-bold uppercase tracking-wider w-1/3">Özellik / Alan</th>
                                <th class="p-4 font-bold uppercase tracking-wider">Açıklama ve Hedef</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Problem Odaklı Geliştirme</td>
                                <td class="p-4 text-gray-700">Türkiye'de yaşanılan 6 Şubat deprem felaketindeki atmosfer verileri toplanmış ve sistemin geliştirilmesinde bu verilerden yararlanılmıştır. (Kaynak: MGM, Akademik Yayınlar).</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Mobilite ve Anlık Analiz</td>
                                <td class="p-4 text-gray-700">İstasyon mobil bir yapıdadır. Geliştirilen sistem, afet bölgesindeki atmosfer verilerini (CO₂, PM2.5 vb.) anlık olarak analiz eder, bölgedeki hava kalitesi hakkında bilgi verir ve bu verileri kayıt altına alır.</td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-semibold text-[#073B4C]">Çok Yönlü Fayda</td>
                                <td class="p-4 text-gray-700">Sistem; afetzedeler için deneyimsel öğrenme ortamı oluşturur, hava kalitesini iyileştirir, ürettiği biyokütle ile döngüsel ekonomiye katkıda bulunur ve ürettiği oksijen ile daha sağlıklı bir yaşam ortamı sağlar.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="podcast-section" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Çevre Bilinci Podcast</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Çevre bilinci, sürdürülebilirlik ve hava kalitesi konularında daha derinlemesine bilgi edinmek için podcastimizi dinleyin.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <iframe width="100%" height="205" allow="encrypted-media" frameborder="0" src="https://www.podomatic.com/embed/v2/podcast/6688084?episode_id=10942087&theme=light" style="border: none; height: 205px; width: 100%;"></iframe>
                   <iframe width="100%" height="205" allow="encrypted-media" frameborder="0" src="https://www.podomatic.com/embed/v2/podcast/6688084?episode_id=10942092&theme=light" style="border: none; height: 205px; width: 100%;"></iframe>  
                    <iframe width="100%" height="205" allow="encrypted-media" frameborder="0" src="https://www.podomatic.com/embed/v2/podcast/6688084?episode_id=10942850&theme=light" style="border: none; height: 205px; width: 100%;"></iframe>
                </div>
            </div>
        </section>
        
        <section id="project-resources" class="py-16 md:py-24">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Proje Kaynakları</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Projemizin kaynak koduna ve daha fazla teknik bilgiye aşağıdaki bağlantıdan ulaşabilirsiniz.
                    </p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto text-center">
                    <a href="https://github.com/Sev84/mobil-mikroalg-egitim1/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center bg-[#073B4C] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#118AB2] transition-colors shadow-md text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.2c2.8-.3 5.5-1.4 5.5-6a5 5 0 0 0-1.5-3.5c.2-1.1.2-2.3 0-3.4 0 0-1.4.3-4.5 1.5A12.2 12.2 0 0 0 12 5.3C9.7 5 7.4 5.3 6 6.3c-3.1-1.2-4.5-1.5-4.5-1.5-.2 1.1-.2 2.3 0 3.4A5 5 0 0 0 2 13.8c0 4.6 2.7 5.7 5.5 6a4.8 4.8 0 0 0-1 3.2v4"></path><path d="M9 18c-2.7 0-3.5-1.5-3.5-1.5s.8-.5 1.5-.5c.7 0 1.5.5 2.5.5 1 0 1.8-.5 2.5-.5.7 0 1.5.5 1.5.5s-.8 1.5-3.5 1.5z"></path></svg>
                        GitHub Deposunu Görüntüle
                    </a>
                </div>
            </div>
        </section>

        <!-- YENİ: Kullanıcı İstatistikleri Bölümü -->
        <section id="stats-section" class="py-16 md:py-24 bg-gray-100">
            <div class="container mx-auto px-6">
                <div class="text-center mb-12 md:mb-16">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">Kullanıcı İstatistikleri</h2>
                    <p class="mt-4 text-lg text-[#073B4C] max-w-3xl mx-auto">
                        Platformumuzun anlık ve genel ziyaretçi sayılarını buradan takip edebilirsiniz.
                    </p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto mb-12">
                    <div class="kpi-card p-6 flex flex-col items-center justify-center">
                        <h4 class="font-bold text-gray-500 text-lg">TOPLAM ZİYARETÇİ</h4>
                        <p id="total-users-display" class="text-5xl font-black text-[#073B4C] mt-2">---</p>
                        <span id="total-users-time" class="text-xs text-gray-400 mt-2"></span>
                    </div>
                    <div class="kpi-card p-6 flex flex-col items-center justify-center">
                        <h4 class="font-bold text-gray-500 text-lg">ANLIK ÇEVRİMİÇİ</h4>
                        <p id="online-users-display" class="text-5xl font-black text-[#06D6A0] mt-2">---</p>
                        <span id="online-users-time" class="text-xs text-gray-400 mt-2"></span>
                    </div>
                </div>
                <!-- Son Ziyaretçiler Kartı -->
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-4xl mx-auto">
                    <h3 class="text-xl font-bold font-heading text-center mb-4 text-[#073B4C]">Son Ziyaretçiler</h3>
                    <ul id="last-visitors-list" class="divide-y divide-gray-200">
                        <li class="py-3 text-center text-gray-500">Konum verileri bekleniyor...</li>
                    </ul>
                </div>
            </div>
        </section>

        <section id="api-key-section" class="py-16 md:py-24 bg-green-50 border-t-4 border-green-500">
            <div class="container mx-auto px-6 max-w-2xl">
                <div class="text-center mb-8">
                    <h2 class="text-3xl md:text-4xl font-bold font-heading text-[#073B4C]">API Anahtarı Ayarları</h2>
                    <p class="mt-4 text-lg text-[#073B4C] mx-auto">
                        Lütfen yapay zeka entegrasyonu için kendi Gemini API Key'inizi girin ya da Proje Sahibi ile iletişim kurun.
                    </p>
                </div>
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <form id="api-key-form">
                        <label for="gemini-api-key-input" class="block text-lg font-semibold text-[#073B4C] mb-2">Gemini API Anahtarınız</label>
                        <input type="password" id="gemini-api-key-input" placeholder="API anahtarınızı buraya yapıştırın" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#06D6A0] focus:outline-none transition-shadow">
                        <p class="text-sm text-gray-500 mt-2">Anahtarınız sadece bu tarayıcıda saklanır ve başka bir yere gönderilmez.</p>
                        <button type="submit" class="w-full mt-6 bg-[#06D6A0] text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition-colors shadow-md text-lg">
                            API Anahtarını Kaydet
                        </button>
                    </form>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-[#073B4C] text-white py-8">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2025 BIQ-Alg 0CO2 Projesi. Tüm Hakları Saklıdır.</p>
        </div>
    </footer>
    
    <div id="message-box" class="message-box"></div>

    <!-- Leaflet JS - Harita için gerekli -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, collection, query, orderBy, limit, onSnapshot, runTransaction, serverTimestamp, deleteDoc, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', function () {
            
            const AQI_API_TOKEN = "08039ad9c3603305b99fc2bcaf155da6e0bfdc31";
            const CITIES = ["Hatay", "Van", "Kahramanmaras", "Gaziantep", "Eskisehir", "Mersin", "Ankara", "Izmir", "Bursa", "Zonguldak"];
            
            const firebaseConfig = {
                apiKey: "AIzaSyBvJNWLHjMqlhAdZXSBqHQuPNnnImNZd4Q",
                authDomain: "biqalgco2-hava-istasyonu.firebaseapp.com",
                databaseURL: "https://biqalgco2-hava-istasyonu-default-rtdb.firebaseio.com",
                projectId: "biqalgco2-hava-istasyonu",
                storageBucket: "biqalgco2-hava-istasyonu.appspot.com",
                appId: "1:1014289654311:web:e37e2a3ffe78a3cc4ba402"
            };
            
            let db;
            let auth;
            let lastHistoryData = [];
            let latestSensorData = null;
            let allCityData = [];
            let chatHistory = [];
            let userGeminiApiKey = ''; 

            let co2Chart, tdsChart, lightChart, tempHumidityChart, pbrPerformanceChart;
            let mymap;
            let cityMarkers = {}; 
            let userLocationMarkers = {}; // YENİ: Kullanıcı konumları için marker deposu

            const CITY_COORDINATES = {
                "Istanbul": [41.0082, 28.9784], "Hatay": [36.2048, 36.1648], "Van": [38.4946, 43.3803],
                "Kahramanmaras": [37.5849, 36.9381], "Gaziantep": [37.0667, 37.3833], "Eskisehir": [39.7767, 30.5206],
                "Mersin": [36.8125, 34.6417], "Ankara": [39.9334, 32.8597], "Izmir": [38.4192, 27.1287],
                "Bursa": [40.1885, 29.0609], "Zonguldak": [41.4566, 31.7988]
            };
            
            function setupApiKeyManagement() {
                const apiKeyForm = document.getElementById('api-key-form');
                const apiKeyInput = document.getElementById('gemini-api-key-input');
                const settingsLink = document.getElementById('settings-nav-link');
                
                userGeminiApiKey = localStorage.getItem('userGeminiApiKey') || '';
                if (userGeminiApiKey) {
                    apiKeyInput.value = userGeminiApiKey;
                } else {
                    settingsLink.classList.add('pulse-animation');
                }

                apiKeyForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newKey = apiKeyInput.value.trim();
                    userGeminiApiKey = newKey;
                    localStorage.setItem('userGeminiApiKey', newKey);
                    showMessage('API Anahtarı başarıyla kaydedildi!', 'success');
                    settingsLink.classList.remove('pulse-animation');
                });

                settingsLink.addEventListener('click', () => {
                    settingsLink.classList.remove('pulse-animation');
                });
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        startRealtimeListeners();
                        loadExternalCityData();
                        setupAiChat();
                        setupUserStatistics(user.uid);
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch(e) { 
                console.error("Firebase başlatma hatası:", e); 
                showMessage("Firebase başlatılamadı. Lütfen konsolu kontrol edin.", "error", 7000);
            }
            
            const POLLUTANT_INFO = { pm25: "PM2.5", pm10: "PM10", o3: "Ozon", no2: "NO₂", so2: "SO₂", co: "CO" };
            const POLLUTANT_UNITS = { pm25: "µg/m³", pm10: "µg/m³", o3: "ppb", no2: "ppb", so2: "ppb", co: "ppm" };
            const MOLECULAR_WEIGHTS = { o3: 48, no2: 46.01, so2: 64.07, co: 28.01 };

            function showMessage(message, type = 'info', duration = 3000) {
                const messageBox = document.getElementById('message-box');
                messageBox.textContent = message;
                messageBox.className = `message-box show ${type}`;
                setTimeout(() => { messageBox.classList.remove('show'); }, duration);
            }

            function convertUgM3ToPpm(value, pollutantCode) {
                const mw = MOLECULAR_WEIGHTS[pollutantCode];
                if (!mw || typeof value !== 'number') {
                    return { value: value, unit: POLLUTANT_UNITS[pollutantCode] || '' };
                }
                const ppm = (value * 24.45) / (mw * 1000);
                return { value: ppm.toFixed(2), unit: 'ppm' };
            }

            function getAqiStatus(aqi) { if (aqi <= 50) return { text: 'İyi', color: 'bg-green-500' }; if (aqi <= 100) return { text: 'Orta', color: 'bg-yellow-500' }; if (aqi <= 150) return { text: 'Hassas', color: 'bg-orange-500' }; if (aqi <= 200) return { text: 'Sağlıksız', color: 'bg-red-500' }; if (aqi <= 300) return { text: 'Çok Sağlıksız', color: 'bg-purple-700' }; return { text: 'Tehlikeli', color: 'bg-red-900' }; }
            function getAqiColor(aqi) { if (aqi <= 50) return '#28a745'; if (aqi <= 100) return '#ffc107'; if (aqi <= 150) return '#fd7e14'; if (aqi <= 200) return '#dc3545'; if (aqi <= 300) return '#6f42c1'; return '#8b0000'; }
            function getCo2ColorForMap(co2) { if (co2 <= 0 || !co2) return '#cccccc'; if (co2 <= 1000) return '#28a745'; if (co2 <= 2000) return '#ffc107'; return '#dc3545'; }
            function getAirQualityStatus(co2) { if (!co2 || co2 <= 0) return { text: "---", color: "text-gray-500", pill: "bg-gray-200 text-gray-800"}; if (co2 <= 1000) return { text: "İyi", color: "text-[#06D6A0]", pill: "bg-green-200 text-green-800" }; if (co2 <= 2000) return { text: "Orta", color: "text-yellow-500", pill: "bg-yellow-200 text-yellow-800" }; return { text: "Kötü", color: "text-red-500", pill: "bg-red-200 text-red-800" }; }
            function formatDate(timestamp) { if (!timestamp) return 'N/A'; const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); return date.toLocaleString('tr-TR', { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }); }
            function formatWaqiDate(dateString) { if(!dateString) return 'N/A'; return new Date(dateString).toLocaleString('tr-TR', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }); }

            async function fetchAirQualityData(city) { try { const response = await fetch(`https://api.waqi.info/feed/${city}/?token=${AQI_API_TOKEN}`); if (!response.ok) { console.error(`WAQI API hatası (${city}): ${response.status} ${response.statusText}`); return null; } const jsonResponse = await response.json(); if (jsonResponse.status === 'ok') { return jsonResponse.data; } else { console.warn(`WAQI API'den ${city} için geçerli veri alınamadı:`, jsonResponse.data); return null; } } catch (error) { console.error(`WAQI API çağrılırken hata (${city}):`, error); return null; } }
            async function loadExternalCityData() { const tableBody = document.getElementById('comparison-table-body'); if (!tableBody) return; tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-500">Veriler yükleniyor...</td></tr>`; allCityData = []; const istanbulDataPromise = fetchAirQualityData('Istanbul'); const otherCitiesPromises = CITIES.map(city => fetchAirQualityData(city)); const [istanbulData, ...otherCitiesData] = await Promise.all([istanbulDataPromise, ...otherCitiesPromises]); allCityData.push({ city: 'Istanbul', data: istanbulData }); CITIES.forEach((city, i) => { allCityData.push({ city: city, data: otherCitiesData[i] }); }); updateComparisonTable(); updateMapMarkers(); }
            
            function updateComparisonTable() {
                const tableBody = document.getElementById('comparison-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';

                if (latestSensorData) {
                    const localStatus = getAirQualityStatus(latestSensorData.co2);
                    const measurementDate = latestSensorData.timestamp?.toDate ? formatDate(latestSensorData.timestamp) : '...';

                    tableBody.innerHTML += `
                        <tr class="bg-blue-50">
                            <td class="p-4 font-semibold text-[#073B4C]">BIQ-Alg İstasyonu (İstanbul)</td>
                            <td class="p-4 font-bold text-lg">---</td>
                            <td class="p-4 font-bold text-lg">${latestSensorData.co2 ? parseFloat(latestSensorData.co2).toFixed(0) : '---'} <span class="text-sm text-gray-500">ppm</span></td>
                            <td class="p-4"><span class="px-3 py-1 text-sm font-bold rounded-full ${localStatus.pill}">${localStatus.text}</span></td>
                            <td class="p-4 text-gray-700">CO₂ (Yerel)</td>
                            <td class="p-4 text-gray-700">${measurementDate}</td>
                        </tr>
                    `;
                }

                allCityData.filter(c => c.city !== 'Istanbul').forEach(cityData => {
                    const { city, data } = cityData;
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    let rowContent = `<td class="p-4 font-semibold text-[#073B4C]">${city}</td>`;
                    if (data && data.aqi) {
                        const status = getAqiStatus(data.aqi);
                        const pollutantCode = (data.dominentpol || '-').toLowerCase();
                        const pollutantName = POLLUTANT_INFO[pollutantCode] || 'Bilinmiyor';
                        const originalValue = data.iaqi && data.iaqi[pollutantCode] ? data.iaqi[pollutantCode].v : '---';
                        
                        let displayValue = '---';
                        let displayUnit = '';

                        if (typeof originalValue === 'number') {
                            if (pollutantCode === 'pm25' || pollutantCode === 'pm10') {
                                displayValue = originalValue;
                                displayUnit = POLLUTANT_UNITS[pollutantCode] || 'µg/m³';
                            } else {
                                const converted = convertUgM3ToPpm(originalValue, pollutantCode);
                                displayValue = converted.value;
                                displayUnit = converted.unit;
                            }
                        }
                        
                        const measurementTime = data.time?.s ? formatWaqiDate(data.time.s) : 'N/A';
                        
                        rowContent += `
                            <td class="p-4 font-bold text-lg">${data.aqi}</td>
                            <td class="p-4 font-bold text-lg">${displayValue} <span class="text-sm text-gray-500">${displayUnit}</span></td>
                            <td class="p-4"><span class="px-3 py-1 text-sm text-white rounded-full ${status.color}">${status.text}</span></td>
                            <td class="p-4 text-gray-700"><span title="${pollutantName}">${pollutantCode.toUpperCase()}</span></td>
                            <td class="p-4 text-gray-700">${measurementTime}</td>
                        `;
                    } else {
                        rowContent += `<td colspan="5" class="p-4 text-red-500">Veri alınamadı.</td>`;
                    }
                    row.innerHTML = rowContent;
                    tableBody.appendChild(row);
                });
            }

            function initializeCharts() { const createChart = (ctx, datasets, suggestedMin, suggestedMax) => { if (!ctx) return null; return new Chart(ctx, { type: 'line', data: { labels: [], datasets: datasets }, options: { animation: false, responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 10 }}, y: { beginAtZero: false, suggestedMin: suggestedMin, suggestedMax: suggestedMax } }, plugins: { legend: { display: true } } } }); }; tempHumidityChart = createChart(document.getElementById('tempHumidityChart')?.getContext('2d'), [{ label: 'Sıcaklık (°C)', data: [], borderColor: '#FF6B6B', tension: 0.2 }, { label: 'Nem (%)', data: [], borderColor: '#118AB2', tension: 0.2 }], 10, 40); co2Chart = createChart(document.getElementById('co2Chart')?.getContext('2d'), [{ label: 'CO₂ (ppm)', data: [], borderColor: '#06D6A0', tension: 0.2, fill: { target: 'origin', above: 'rgba(6, 214, 160, 0.1)'} }], 300, 2000); tdsChart = createChart(document.getElementById('tdsChart')?.getContext('2d'), [{ label: 'TDS (ppm)', data: [], borderColor: '#EF476F', tension: 0.2, fill: { target: 'origin', above: 'rgba(239, 71, 111, 0.1)'} }], 50, 600); lightChart = createChart(document.getElementById('lightChart')?.getContext('2d'), [{ label: 'Işık (lux)', data: [], borderColor: '#FFD166', tension: 0.2, fill: { target: 'origin', above: 'rgba(255, 209, 102, 0.1)'} }], 200, 900); const pbrCtx = document.getElementById('pbrPerformanceChart').getContext('2d'); pbrPerformanceChart = new Chart(pbrCtx, { type: 'bar', data: { labels: ['Dikey Tübüler FBR', 'Düz Panel FBR', 'Açık Havuz Sistemleri'], datasets: [{ label: 'CO₂ Giderim Verimliliği (%)', data: [90, 75, 40], backgroundColor: ['#118AB2', '#073B4C', '#073B4C'], borderColor: ['#118AB2', '#073B4C', '#073B4C'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Verimlilik (%)', color: '#073B4C' }, ticks: { color: '#073B4C' }, grid: { color: 'rgba(7, 59, 76, 0.1)' } }, x: { ticks: { color: '#073B4C' }, grid: { color: 'rgba(7, 59, 76, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return context.dataset.label + ': ' + context.parsed.y + '%'; } } } } } }); }
            
            function updateAllCharts(history) {
                const MAX_CHART_POINTS = 50;
                lastHistoryData = history; 
                const labels = [], tempData = [], humData = [], co2Data = [], tdsData = [], lightData = [];
                
                const dataSlice = history.slice(-MAX_CHART_POINTS);

                dataSlice.forEach(dp => {
                    if (dp.timestamp && dp.timestamp.toDate) {
                        const timestamp = dp.timestamp.toDate();
                        labels.push(timestamp);
                        tempData.push(isNaN(dp.temperature) ? null : parseFloat(dp.temperature));
                        humData.push(isNaN(dp.humidity) ? null : parseFloat(dp.humidity));
                        co2Data.push(isNaN(dp.co2) ? null : parseFloat(dp.co2));
                        tdsData.push(isNaN(dp.tds_value) ? null : parseFloat(dp.tds_value));
                        lightData.push(isNaN(dp.light_value) ? null : parseFloat(dp.light_value));
                    }
                });
                if(tempHumidityChart) { tempHumidityChart.data.labels = labels; tempHumidityChart.data.datasets[0].data = tempData; tempHumidityChart.data.datasets[1].data = humData; tempHumidityChart.update('none'); } 
                if(co2Chart){ co2Chart.data.labels = labels; co2Chart.data.datasets[0].data = co2Data; co2Chart.update('none'); } 
                if(tdsChart){ tdsChart.data.labels = labels; tdsChart.data.datasets[0].data = tdsData; tdsChart.update('none'); } 
                if(lightChart){ lightChart.data.labels = labels; lightChart.data.datasets[0].data = lightData; lightChart.update('none'); } 
                updateEfficiencyAnalysis(history);
            }

            function initializeMap() { if (mymap) { mymap.remove(); } mymap = L.map('mapid').setView([38.9637, 35.2433], 6); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(mymap); }
            function updateMapMarkers() { if (!mymap) return; for (const city in cityMarkers) { mymap.removeLayer(cityMarkers[city]); } cityMarkers = {}; if (latestSensorData && latestSensorData.co2) { const co2Value = parseFloat(latestSensorData.co2); const color = getCo2ColorForMap(co2Value); const status = getAirQualityStatus(co2Value).text; const markerHtml = `<div class="aqi-marker" style="background-color: ${color};">${co2Value.toFixed(0)}</div>`; const customIcon = L.divIcon({ className: '', html: markerHtml, iconSize: [40, 40], iconAnchor: [20, 20] }); const istanbulCoords = CITY_COORDINATES["Istanbul"]; if (istanbulCoords) { const marker = L.marker(istanbulCoords, { icon: customIcon }).addTo(mymap).bindPopup(`<b>BIQ-Alg İstasyonu (İstanbul)</b><br>CO₂: ${co2Value.toFixed(0)} ppm (${status})`); cityMarkers["Istanbul"] = marker; } } allCityData.filter(c => c.city !== 'Istanbul' && c.data && c.data.aqi).forEach(cityData => { const aqi = parseInt(cityData.data.aqi, 10); if (isNaN(aqi)) return; const color = getAqiColor(aqi); const status = getAqiStatus(aqi).text; const mainPollutant = cityData.data.dominentpol ? (POLLUTANT_INFO[cityData.data.dominentpol] || cityData.data.dominentpol.toUpperCase()) : 'N/A'; const markerHtml = `<div class="aqi-marker" style="background-color: ${color};">${aqi}</div>`; const customIcon = L.divIcon({ className: '', html: markerHtml, iconSize: [40, 40], iconAnchor: [20, 20] }); const cityCoords = CITY_COORDINATES[cityData.city]; if (cityCoords) { const marker = L.marker(cityCoords, { icon: customIcon }).addTo(mymap).bindPopup(`<b>${cityData.city}</b><br>HKİ: ${aqi} (${status})<br>Ana Kirletici: ${mainPollutant}`); cityMarkers[cityData.city] = marker; } }); }
            
            function updateUserLocationMarkers(visitors) {
                if (!mymap) return;

                // Mevcut kullanıcı ikonlarını temizle
                Object.values(userLocationMarkers).forEach(marker => mymap.removeLayer(marker));
                userLocationMarkers = {};

                const userIconSvg = `<svg viewBox="0 0 32 32" fill="#118AB2" style="background:rgba(255,255,255,0.7); border-radius: 50%; padding: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.4);"><path d="M16 4a5 5 0 100 10 5 5 0 000-10zm-7 14c0-3.9 3.1-7 7-7s7 3.1 7 7v2h-2v-2c0-2.8-2.2-5-5-5s-5 2.2-5 5v2H9v-2z"></path></svg>`;
                const userIcon = L.divIcon({
                    html: userIconSvg,
                    className: '',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                visitors.forEach((visitor, index) => {
                    if (visitor.lat && visitor.lng) {
                        const marker = L.marker([visitor.lat, visitor.lng], { icon: userIcon })
                            .addTo(mymap)
                            .bindPopup(`<b>Ziyaretçi</b><br>${visitor.location}`);
                        userLocationMarkers[index] = marker;
                    }
                });
            }

            function startRealtimeListeners() { const appId = 'default-app-id'; const latestDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'sensors', 'current_data'); onSnapshot(latestDocRef, (docSnap) => { if (docSnap.exists()) { latestSensorData = docSnap.data(); updateKpiCards(latestSensorData); updateComparisonTable(); updateMapMarkers(); } else { console.log(`No latest sensor data found in Firestore at 'artifacts/${appId}/public/data/sensors/current_data'.`); showMessage("Sensör verisi bulunamadı. Cihazın bağlı olduğundan emin olun.", "info", 5000); } }, (error) => { console.error("Latest sensor data dinlenirken hata:", error); showMessage("Sensör verileri alınırken hata oluştu. Firebase Güvenlik Kurallarınızı kontrol edin.", "error", 7000); }); const historyCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'sensor_history'); onSnapshot(query(historyCollectionRef, orderBy('timestamp', 'desc'), limit(200)), (snapshot) => { const history = []; snapshot.forEach(doc => history.push(doc.data())); updateAllCharts(history.reverse()); }, (error) => { console.error("Sensor history data dinlenirken hata:", error); showMessage("Geçmiş verileri alınırken hata oluştu. Firebase Güvenlik Kurallarınızı kontrol edin.", "error", 7000); }); }
            function updateKpiCards(data) { document.getElementById('kpi-co2').textContent = `${data.co2 ? data.co2.toFixed(0) : '---'} ppm`; const airQuality = getAirQualityStatus(data.co2); const kpiAirQualityEl = document.getElementById('kpi-air-quality'); kpiAirQualityEl.textContent = airQuality.text; kpiAirQualityEl.className = `text-3xl font-black mt-1 ${airQuality.color}`; document.getElementById('kpi-light').textContent = `${data.light_value ? data.light_value.toFixed(0) : '---'} lux`; document.getElementById('kpi-temp').textContent = `${data.temperature ? data.temperature.toFixed(1) : '--'} °C`; document.getElementById('kpi-humidity').textContent = `${data.humidity ? data.humidity.toFixed(0) : '--'} %`; document.getElementById('kpi-tds').textContent = `${data.tds_value ? data.tds_value.toFixed(0) : '---'} ppm`; }

            function setupUserStatistics(userId) {
                const appId = 'default-app-id';
                const statsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'stats', 'totals');
                const presenceColRef = collection(db, 'artifacts', appId, 'public', 'data', 'presence');
                const userPresenceRef = doc(presenceColRef, userId);
                const visitorsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'visitors');
                const userVisitorRef = doc(visitorsColRef, userId);

                const hasVisited = localStorage.getItem('hasVisited');
                if (!hasVisited) {
                    runTransaction(db, async (transaction) => {
                        const statsDoc = await transaction.get(statsDocRef);
                        if (!statsDoc.exists()) {
                            transaction.set(statsDocRef, { totalUsers: 1 });
                        } else {
                            const newTotal = (statsDoc.data().totalUsers || 0) + 1;
                            transaction.update(statsDocRef, { totalUsers: newTotal });
                        }
                    }).then(() => {
                        localStorage.setItem('hasVisited', 'true');
                    }).catch(error => console.error("Toplam kullanıcı sayısını artırma hatası:", error));
                }

                onSnapshot(statsDocRef, (doc) => {
                    const totalUsers = doc.exists() ? doc.data().totalUsers : 0;
                    document.getElementById('total-users-display').textContent = totalUsers;
                    document.getElementById('total-users-time').textContent = `Son Güncelleme: ${new Date().toLocaleTimeString('tr-TR')}`;
                });

                window.addEventListener('beforeunload', () => { deleteDoc(userPresenceRef); });

                const setOnline = () => { runTransaction(db, async (t) => t.set(userPresenceRef, { lastSeen: serverTimestamp() })).catch(err => console.error("Set online transaction failed:", err)); };
                setOnline();
                setInterval(setOnline, 60000); 

                onSnapshot(presenceColRef, (snapshot) => {
                    const now = Date.now();
                    const onlineThreshold = now - 2 * 60 * 1000; 
                    let onlineCount = 0;
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (data.lastSeen && data.lastSeen.toMillis() > onlineThreshold) {
                            onlineCount++;
                        } else {
                            batch.delete(doc.ref);
                        }
                    });
                    batch.commit().catch(err => console.error("Eski kullanıcıları temizleme hatası:", err));
                    document.getElementById('online-users-display').textContent = onlineCount;
                    document.getElementById('online-users-time').textContent = `Son Güncelleme: ${new Date().toLocaleTimeString('tr-TR')}`;
                });
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=tr`);
                            const data = await response.json();
                            const locationString = data.city ? `${data.city}, ${data.countryName}` : data.countryName;
                            await setDoc(userVisitorRef, { location: locationString, lat: latitude, lng: longitude, timestamp: serverTimestamp() });
                        } catch (error) {
                            console.error('Konum bilgisi alınamadı veya kaydedilemedi:', error);
                            await setDoc(userVisitorRef, { location: 'Bilinmeyen Konum', lat: null, lng: null, timestamp: serverTimestamp() });
                        }
                    }, async (error) => {
                        console.warn('Kullanıcı konum iznini reddetti.', error.message);
                        await setDoc(userVisitorRef, { location: 'Konum Paylaşılmadı', lat: null, lng: null, timestamp: serverTimestamp() });
                    });
                }

                const visitorsQuery = query(visitorsColRef, orderBy('timestamp', 'desc'), limit(10));
                onSnapshot(visitorsQuery, (snapshot) => {
                    const listElement = document.getElementById('last-visitors-list');
                    listElement.innerHTML = '';
                    const visitorsForMap = [];
                    if(snapshot.empty) {
                        listElement.innerHTML = '<li class="py-3 text-center text-gray-500">Henüz ziyaretçi yok.</li>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const visitor = doc.data();
                        visitorsForMap.push(visitor);
                        const li = document.createElement('li');
                        li.className = 'py-3 flex justify-between items-center';
                        li.innerHTML = `
                            <span class="text-gray-700">${visitor.location}</span>
                            <span class="text-sm text-gray-500">${visitor.timestamp ? formatDate(visitor.timestamp) : ''}</span>
                        `;
                        listElement.appendChild(li);
                    });
                    updateUserLocationMarkers(visitorsForMap);
                });
            }

            async function updateEfficiencyAnalysis(history) {
                const analysisElement = document.getElementById('efficiency-analysis');
                if (!analysisElement) return;
                if (!userGeminiApiKey) { analysisElement.innerHTML = `<p class="text-center text-yellow-300">Analiz için lütfen Ayarlar bölümünden geçerli bir Gemini API Anahtarı girin.</p>`; return; }
                if (history.length < 3) { analysisElement.innerHTML = `<p class="text-center">Yeterli veri toplanıyor...</p>`; return; }
                analysisElement.innerHTML = `<p class="text-center text-gray-300">Analiz üretiliyor...</p>`;
                const recentHistory = history.slice(-5);
                const latestData = recentHistory[recentHistory.length - 1];
                if (!latestData) { analysisElement.innerHTML = `<p class="text-red-300">Analiz için yeterli son veri yok.</p>`; return; }
                const prompt = `Sen BIQ-Alg 0CO2 projesi için bir uzman veri analistisin. Görevin, YALNIZCA aşağıda sağlanan verilere dayanarak kısa ve anlaşılır bir verimlilik analizi yapmaktır. Hava temizleme verimliliğini değerlendirmek için aşağıdaki gerçek zamanlı sensör verilerini analiz et. Özellikle CO2 seviyesindeki trende odaklan. Verilerde dikkat çekici bir değişiklik veya anormallik varsa belirt. Analizini 100 kelimeyi geçmeyecek şekilde, bilgilendirici ve net bir üslupla Türkçe olarak sun. Son Veri: - CO2: ${latestData.co2 ? latestData.co2.toFixed(0) : 'N/A'} ppm - Hava Kalitesi (CO2 bazlı): ${getAirQualityStatus(latestData.co2).text} - Işık Şiddeti: ${latestData.light_value ? latestData.light_value.toFixed(0) : 'N/A'} lux - Sıcaklık: ${latestData.temperature ? latestData.temperature.toFixed(1) : 'N/A'}°C - Nem: ${latestData.humidity ? latestData.humidity.toFixed(1) : 'N/A'}% - Zaman: ${formatDate(latestData.timestamp)} Geçmiş Veriler (Son 5, en eskiden en yeniye): ${recentHistory.map(d => `- Zaman: ${formatDate(d.timestamp)}, CO2: ${d.co2 ? d.co2.toFixed(0) : 'N/A'} ppm`).join('\n')}`;
                try {
                    let chatHistoryForAnalysis = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistoryForAnalysis };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userGeminiApiKey}`;
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { const errorBody = await response.json(); throw new Error(`API hatası: ${response.status} ${errorBody.error?.message || response.statusText}`); }
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) { analysisElement.innerHTML = `<p>${result.candidates[0].content.parts[0].text}</p>`; } 
                    else { analysisElement.innerHTML = `<p class="text-red-300">Analiz oluşturulamadı. Geçerli bir yanıt alınamadı.</p>`; }
                } catch (error) { console.error("Yapay Zeka analizi sırasında hata:", error); analysisElement.innerHTML = `<p class="text-red-300">Analiz hatası: ${error.message}. Lütfen API anahtarınızı kontrol edin.</p>`; }
            }
            
            const SYSTEM_PROMPT = `Sen, BIQ-Alg 0CO2 projesinin yapay zeka asistanısın. Görevin, kullanıcılara proje hakkında bilgi vermek, canlı verileri yorumlamak ve genel soruları yanıtlamaktır. Cevapların her zaman yardımsever, bilgilendirici ve Türkçe olmalıdır.

### Proje Bilgileri:
- **Proje Adı:** BIQ-Alg 0CO2: Afet Sonrası Temiz Nefes
- **Ana Amaç:** Afet bölgelerine mobil istasyonlar aracılığıyla temiz hava, sürdürülebilir enerji ve umut götürmek. Proje, özellikle 6 Şubat Türkiye depreminden ilham almıştır.
- **Teknoloji:** Çekirdek teknolojimiz, mikroalglerin fotosentez gücünü kullanan Dikey Tübüler Fotobiyoreaktörlerdir (FBR). Bu reaktörler, karasal bitkilerden 50 kata kadar daha verimli CO₂ yakalar.
- **Faydaları:**
    1.  **Hava Temizleme:** Havadaki CO₂'yi ve diğer kirleticileri filtreler.
    2.  **Oksijen Üretimi:** Fotosentez yoluyla temiz oksijen üretir.
    3.  **Döngüsel Ekonomi:** Üretilen biyokütle, gübre veya biyoyakıt gibi değerli ürünlere dönüştürülebilir.
    4.  **Eğitim:** Mobil istasyonlar, afet bölgelerindeki insanlar için birer deneyimsel öğrenme merkezi görevi görür.
- **Veri Toplama:** İstasyonlarımız; CO₂, hava kalitesi, sıcaklık, nem, ışık şiddeti ve su kalitesi (TDS) gibi verileri anlık olarak toplar ve bu panel üzerinden yayınlar.

### Görevlerin:
1.  **Proje Sorularını Yanıtla:** "Bu proje ne işe yarar?", "Hangi teknolojiyi kullanıyorsunuz?" gibi sorulara yukarıdaki bilgileri kullanarak cevap ver.
2.  **Canlı Verileri Yorumla:** Kullanıcı "Hava nasıl?" veya "CO2 seviyesi kaç?" diye sorduğunda, sana aşağıda sağlanacak olan 'Mevcut Canlı Veriler' bölümündeki bilgileri kullanarak cevap ver.
3.  **Genel Bilgi Sağla:** Hava kirliliği, mikroalgler, sürdürülebilirlik gibi konulardaki genel soruları, internetten edindiğin bilgilerle yanıtla.
4.  **Kibar ve Yardımsever Ol:** Her zaman pozitif ve destekleyici bir dil kullan.`;

            function setupAiChat() {
                const chatForm = document.getElementById('chat-form');
                const chatInput = document.getElementById('chat-input');
                const chatContainer = document.getElementById('chat-container');
                const chatSubmitButton = document.getElementById('chat-submit');
                if (!chatForm) return;
                
                chatForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    const userMessage = chatInput.value.trim();
                    if (!userMessage) return;
                    if (!userGeminiApiKey) { appendMessage('Lütfen önce Ayarlar bölümünden Gemini API Anahtarınızı girin.', 'ai'); return; }
                    
                    appendMessage(userMessage, 'user');
                    chatInput.value = '';
                    chatSubmitButton.disabled = true;
                    
                    let contextPrompt = SYSTEM_PROMPT;
                    if (latestSensorData) {
                        contextPrompt += `

### Mevcut Canlı Veriler (Referans için):
- CO₂ Seviyesi: ${latestSensorData.co2 ? latestSensorData.co2.toFixed(0) : 'N/A'} ppm
- Hava Kalitesi (CO₂'ye göre): ${getAirQualityStatus(latestSensorData.co2).text}
- Sıcaklık: ${latestSensorData.temperature ? latestSensorData.temperature.toFixed(1) : 'N/A'} °C
- Nem: ${latestSensorData.humidity ? latestSensorData.humidity.toFixed(0) : 'N/A'} %
- Son Veri Zamanı: ${formatDate(latestSensorData.timestamp)}
`;
                    }
                    
                    const requestContents = [
                        { role: "user", parts: [{ text: contextPrompt }] },
                        { role: "model", parts: [{ text: "Anladım. Ben BIQ-Alg 0CO2 projesinin asistanıyım. Size nasıl yardımcı olabilirim?" }] }
                    ];

                    chatHistory.forEach(turn => requestContents.push(turn));
                    requestContents.push({ role: "user", parts: [{ text: userMessage }] });

                    chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

                    try {
                        const payload = { contents: requestContents };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userGeminiApiKey}`;
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) { const errorBody = await response.json(); throw new Error(`API hatası: ${response.status} ${errorBody.error?.message || response.statusText}`); }
                        const result = await response.json();
                        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                            const aiResponseText = result.candidates[0].content.parts[0].text;
                            appendMessage(aiResponseText, 'ai');
                            chatHistory.push({ role: "model", parts: [{ text: aiResponseText }] });
                        } else { 
                            appendMessage("Üzgünüm, yanıt alamadım. Lütfen tekrar deneyin.", 'ai'); 
                            chatHistory.pop();
                        }
                    } catch (error) { 
                        console.error("Yapay Zeka sohbeti sırasında hata:", error); 
                        appendMessage(`Bir hata oluştu: ${error.message}. Lütfen API Anahtarınızı kontrol edin.`, 'ai');
                        chatHistory.pop();
                    } finally { 
                        chatSubmitButton.disabled = false; 
                        chatContainer.scrollTop = chatContainer.scrollHeight; 
                    }
                });
                function appendMessage(text, sender) { const messageDiv = document.createElement('div'); messageDiv.classList.add('chat-message', sender); const p = document.createElement('p'); p.textContent = text; messageDiv.appendChild(p); chatContainer.appendChild(messageDiv); chatContainer.scrollTop = chatContainer.scrollHeight; }
            }

            function downloadCSV() { if (lastHistoryData.length === 0) { showMessage("İndirilecek veri yok.", "info"); return; } const headers = ["Timestamp", "CO2 (ppm)", "Temperature (°C)", "Humidity (%)", "TDS (ppm)", "Light (lux)"]; const csvRows = [headers.join(',')]; lastHistoryData.forEach(data => { const row = [formatDate(data.timestamp), data.co2, data.temperature, data.humidity, data.tds_value, data.light_value].map(item => `"${item}"`).join(','); csvRows.push(row); }); const csvString = csvRows.join('\n'); const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `BIQ-Alg_Sensor_Data_${new Date().toISOString().slice(0, 10)}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); showMessage("Veriler CSV olarak indirildi!", "success"); }
            const downloadCsvButton = document.getElementById('download-csv-button');
            if (downloadCsvButton) { downloadCsvButton.addEventListener('click', downloadCSV); }

            // Uygulama başlangıcı
            initializeCharts();
            initializeMap();
            setupApiKeyManagement(); 

            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    navLinks.forEach(item => item.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
